# Операционный плейбук: цены, платежи, миграция

Дата подготовки: 2026-02-17

## 1) Ценовая политика (применена)

В `plans.json` выставлена базовая сетка:

- 30 дней: `299 RUB`
- 60 дней: `550 RUB`
- 180 дней: `1490 RUB`
- 365 дней: `2590 RUB`

Та же логика продублирована для `USD` и `XTR`.

## 1.1) Картинка на старте бота

Добавлена поддержка переменной:

- `BOT_START_IMAGE`

Можно указать:

- прямую `https://` ссылку на изображение;
- локальный путь к файлу в контейнере (если файл смонтирован в контейнер).

Если картинка не отправится, бот автоматически откатится к текстовому стартовому сообщению.

## 1.2) Редактор промокодов (обновлено)

В админке теперь доступны:

- быстрые пресеты: `1, 2, 3, 4, 5, 6, 7, 14, 20, 30, 90, 180, 365` дней;
- кнопка `Ввести дни вручную` для любого периода;
- валидация ручного ввода: от `1` до `3650` дней.

## 2) Платежи в боте (кроме Stars)

В `.env` добавлены/подготовлены:

- `SHOP_PAYMENT_YOOMONEY_ENABLED=True`
- `SHOP_PAYMENT_CRYPTOMUS_ENABLED=True`
- `SHOP_PAYMENT_STARS_ENABLED=True`
- `SHOP_PAYMENT_YOOKASSA_ENABLED=False`
- `SHOP_PAYMENT_HELEKET_ENABLED=False`

И поля для ключей:

- `YOOMONEY_WALLET_ID`
- `YOOMONEY_NOTIFICATION_SECRET`
- `CRYPTOMUS_API_KEY`
- `CRYPTOMUS_MERCHANT_ID`

Пока ключи пустые, соответствующий шлюз не активируется (бот сам отключит его на старте).

### Минимальный чеклист запуска YooMoney

1. Заполнить в `.env`:
   - `YOOMONEY_WALLET_ID`
   - `YOOMONEY_NOTIFICATION_SECRET`
2. В кабинете YooMoney настроить HTTP-уведомления:
   - URL: `https://www.superbebra.uk:8443/yoomoney`
3. Перезапустить бота:
   - `docker compose up -d --build bot`

### Минимальный чеклист запуска Cryptomus

1. Заполнить в `.env`:
   - `CRYPTOMUS_API_KEY`
   - `CRYPTOMUS_MERCHANT_ID`
2. Callback в заказе формируется ботом автоматически:
   - `https://www.superbebra.uk:8443/cryptomus`
3. Перезапустить бота:
   - `docker compose up -d --build bot`

## 3) Миграция старых клиентов в оплату через бота

Рекомендованный сценарий: мягкий cutover, без резкого удаления.

### План по датам

- До 2026-03-09: предупреждаем пользователей, что продление только через бота.
- 2026-03-10: новые продления принимаются только через бота.
- 2026-03-17: отключаем legacy-клиентов, кто не перешел.

### Сегментация клиентов

- Клиенты бота: email в 3X-UI = числовой Telegram ID.
- Legacy-клиенты: email в 3X-UI = ник/строка (не tg_id).

Важно:

- Не удаляйте `inbound` целиком. Это удалит саму точку входа и затронет новых клиентов.
- Переносите именно клиентов (или просто выдайте промокоды, затем отключите legacy-клиентов).

### Текст рассылки (за 7 дней)

```
Друзья, с 10 марта 2026 продление VPN переходит в автоматический формат через Telegram-бота.

Что изменится:
1) Оплата и продление будут только через бота.
2) Переводы на карту/по номеру больше не принимаются.
3) Доступ к серверам и ключи останутся, просто продление станет автоматическим.

Что сделать:
1) Откройте бота @AFZVPN_bot
2) Нажмите «Подписка»
3) Выберите срок и оплатите внутри бота

Если нужна помощь с переносом — пишите в поддержку.
```

### Текст в день cutover

```
Сегодня, 10 марта 2026, продление VPN работает только через бота @AFZVPN_bot.
Переводы напрямую больше не обрабатываются.
Чтобы продлить доступ: Подписка -> Оплатить в боте.
```

### Текст финального напоминания (перед отключением)

```
Напоминание: у вас остался 1 день до отключения старого способа доступа.
Чтобы сохранить доступ без перерыва, продлите подписку через бота @AFZVPN_bot:
Подписка -> Оплатить.
```

### Автогенерация промокодов для legacy-клиентов

Добавлен скрипт:

- `scripts/generate_legacy_promocodes.py`

Сценарий безопасного запуска:

1. Предпросмотр (без записей в БД):
   - `python3 scripts/generate_legacy_promocodes.py --dry-run --xui-db /etc/x-ui/x-ui.db --bot-db app/data/bot_database.sqlite3 --output-csv /tmp/legacy_promocodes_preview.csv`
2. Фактическое создание кодов:
   - `python3 scripts/generate_legacy_promocodes.py --xui-db /etc/x-ui/x-ui.db --bot-db app/data/bot_database.sqlite3 --output-csv /tmp/legacy_promocodes.csv`
3. Разослать пользователям их персональные коды из CSV.
4. После подтверждения, что клиенты активировали код, отключать legacy-клиентов.

По умолчанию скрипт берет только клиентов с нечисловым `email` и создает одноразовые промокоды.

## 4) Что лучше не делать

- Не удалять всех клиентов в один день без предупреждения.
- Не делать ручные продления параллельно с ботом после даты cutover.
- Не включать платежный шлюз без заполненных ключей и проверки webhook.

## 5) Telegram Stars: курс, комиссии, ограничения

### Практический курс для клиента

Для России фактическая цена Stars для клиента обычно плавает.
Ориентир по практике: `100 Stars ~= 150-200 RUB`.

Из этого диапазона:

- `299 RUB` соответствует примерно `150-199 Stars` по цене покупки для клиента.
- Но это не ваша чистая выручка: в payout экономика другая.

### Почему 1 RUB != 1 Star

По официальной таблице Telegram для мобильных покупок:

- Пользователь платит за `100 Stars` около `$1.99`.
- Продавец получает за те же `100 Stars` около `$1.30`.

Это значит, что у пользователя и у продавца разная экономика Stars.

### Текущая рабочая настройка под «чистыми RUB»

На 2026-02-17 использована модель:

- курс ЦБ РФ: `1 USD = 76.6201 RUB`
- payout Telegram: `1 Star = 0.013 USD`
- итог: `~0.996 RUB` чистыми за 1 star

Поэтому в тарифах для сохранения чистой выручки выставлено:

- 30 дней (`299 RUB` чистыми): `301 XTR`
- 60 дней (`550 RUB` чистыми): `553 XTR`
- 180 дней (`1490 RUB` чистыми): `1496 XTR`
- 365 дней (`2590 RUB` чистыми): `2601 XTR`

### Ограничения вывода

- Вывод возможен только для stars старше `21` дня.
- Нужен владелец бота/канала и включенный `2FA`.
- Должна быть доступность вывода для аккаунта/региона.
- Минимум/максимум вывода задается конфигом Telegram:
  - минимум: `1000` stars
  - максимум: `25 000 000` stars за операцию
